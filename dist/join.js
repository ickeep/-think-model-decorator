'use strict';var _regenerator=require('babel-runtime/regenerator'),_regenerator2=_interopRequireDefault(_regenerator),_promise=require('babel-runtime/core-js/promise'),_promise2=_interopRequireDefault(_promise),_asyncToGenerator2=require('babel-runtime/helpers/asyncToGenerator'),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_keys=require('babel-runtime/core-js/object/keys'),_keys2=_interopRequireDefault(_keys);exports.__esModule=!0;exports.default=function(a){a.prototype.getJoinFieldObj=function(){for(var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},b=a.modelObj,c=a.fields,d=think.isArray(c)?c:c.split(','),e=(0,_keys2.default)(b),f={},g=0;g<e.length;g+=1)for(var h=e[g],k=b[h].field,l=(0,_keys2.default)(k),m=!1,n=0;n<l.length;n+=1){var o=l[n],p=k[o];0<=d.indexOf(p)&&(!f[h]&&(f[h]=[]),f[h].push(p),m=!0)}return f},a.prototype.getJoinQuery=function(){var a=this,b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},c=b.rows,d=b.modelObj,e=b.newFieldObj,f=[],g=[];return(0,_keys2.default)(e).forEach(function(b){var e=d[b],h=[];(0,_keys2.default)(e.field).forEach(function(a){h.push(a+' AS '+e.field[a])});var j=e.on,k=j[0];h.push(k+' AS '+j[1]);for(var l,m={},n=0;n<c.length;n+=1){// 如果存在条件
if(l=c[n],e.where){var p=e.where.field,q=e.where.val;if(l[p]!==q)continue}var r=l[j[1]];'undefined'!=typeof r&&''!==r&&(m[r]=!0)}var o=(0,_keys2.default)(m);if(0<o.length){var s={};s[k]=['IN',o],f.push(b),g.push(a.model(b).where(s).field(h.join(',')).select())}}),[f,g]},a.prototype.getJoinResultData=function(){var a=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function a(){var b,c,d,e,f,g,h,k,l,m,n,o,p=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},q=p.modelObj,r=p.modelPromise,s=p.promiseArr;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b={},think.isEmpty(s)){a.next=6;break}return a.next=4,_promise2.default.all(s);case 4:for(c=a.sent,d=0;d<c.length;d+=1)if(e=r[d],f=c[d],g=q[e].type,h=q[e].on[1],'HAS_MANY'===g){for(k={},l=0;l<f.length;l+=1)m=f[l],k[m[h]]||(k[m[h]]=[]),k[m[h]].push(l);b[e]={keyToIndexArr:k,newRows:f}}else{for(n={},o=0;o<f.length;o+=1)n[f[o][h]]=o;b[e]={keyToIndex:n,newRows:f}}case 6:return a.abrupt('return',b);case 7:case'end':return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),a.prototype.getQueryJoinModel=function(){var a=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},c=b.where,d=b.model,e={};if(c){var f=this.getJoinModel?this.getJoinModel()||{}:{},g=[];(0,_keys2.default)(f).forEach(function(a){var b=f[a];if('HAS_MANY'===b.type){var d=b.field;(0,_keys2.default)(d).forEach(function(b){var e=d[b],h=c[e]||c[b];if(h){h+='';var i={};i.tableName=a,i.conf=f[a],i.where={},i.where=b+(0<h.indexOf(',')?' IN ( '+h.split(',')+' )':' = '+h),g.push(i)}})}}),think.isEmpty(g)||g.forEach(function(){var b=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function b(c){var f,g;return _regenerator2.default.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:f=c.conf,g='SELECT DISTINCT '+f.on[0]+' FROM '+a.tablePrefix+c.tableName+' WHERE ( '+c.where+' )',f.on[1]===f.on[0]&&(e[f.on[1]]=a.tableName+'.'+f.on[1]+' as '+f.on[1]),d.join({join:'inner',table:g,as:c.tableName,on:[f.on[1],f.on[0]]});case 4:case'end':return b.stop();}},b,a)}));return function(){return b.apply(this,arguments)}}())}return{model:d,asFields:e}},a.prototype.dataJoinField=function(){var a=(0,_asyncToGenerator3.default)(/*#__PURE__*/_regenerator2.default.mark(function a(){var b,c,d,e,f,g,h,i=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{},j=i.data,k=i.fields;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!(think.isEmpty(j)||think.isEmpty(k))){a.next=2;break}return a.abrupt('return',j);case 2:if(b=think.isArray(j)?j:[j],c=this.getJoinModel?this.getJoinModel():{},d=this.getJoinFieldObj({modelObj:c,fields:k}),!think.isEmpty(d)){a.next=7;break}return a.abrupt('return',j);case 7:return e=this.getJoinQuery({rows:b,modelObj:c,newFieldObj:d}),f=e[0],g=e[1],a.next=10,this.getJoinResultData({modelObj:c,modelPromise:f,promiseArr:g});case 10:return h=a.sent,(0,_keys2.default)(d).forEach(function(a){// 条件
// 1对1 1对多
for(var e,f=c[a],g=d[a],k=f.type,l=f.where,m=0;m<b.length;m+=1){if(e=b[m],l){var p=l.field,q=l.val;if(e[p]!==q)continue}for(var n=function(b){var d=g[b];e[d]='';var f=h[a];if(f){var i=c[a].on,j=e[i[1]];if('HAS_MANY'===k&&f.keyToIndexArr&&f.newRows){var l=f.keyToIndexArr[j]||[],m=[];l.forEach(function(a){m.push(f.newRows[a]?f.newRows[a][d]||'':'')}),e[d]=m.join(',')}if(f.keyToIndex&&f.newRows){var n=f.keyToIndex[j];0<=n&&(e[d]=f.newRows[n]?f.newRows[n][d]||'':'')}}},b=0;o<g.length;o+=1)n(b)}}),a.abrupt('return',think.isArray(j)?b:b[0]);case 13:case'end':return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()};function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}